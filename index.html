<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Flower Journey Map</title>
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"
/>
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"
/>
<style>
  body {
    margin: 0;
    font-family: Arial, sans-serif;
    height: 100vh;
    display: flex;
    flex-direction: column;
  }

  #sidebar {
    width: 100%;
    background-color: #2e8b57;
    padding: 10px 20px;
    box-sizing: border-box;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    grid-auto-rows: minmax(36px, auto);
    gap: 10px 15px;
    align-items: center;
    user-select: none;
    min-height: 120px;
  }

  h1 {
    grid-column: 1 / -1;
    font-size: 22px;
    margin: 0 0 10px 0;
    color: white;
    user-select: none;
  }

  button,
  select,
  input[type="text"] {
    font-size: 14px;
    border-radius: 5px;
    border: none;
    padding: 6px 10px;
    color: black;
    cursor: pointer;
    user-select: none;
    width: 100%;
    box-sizing: border-box;
  }

  label {
    font-size: 14px;
    color: white;
    user-select: none;
  }

  .input-container {
    position: relative;
    width: 100%;
  }

  .clear-btn {
    position: absolute;
    right: 6px;
    top: 50%;
    transform: translateY(-50%);
    width: 20px;
    height: 20px;
    padding: 0;
    font-weight: bold;
    line-height: 20px;
    text-align: center;
    border-radius: 50%;
    background: #eee;
    color: #333;
    display: none;
    cursor: pointer;
    user-select: none;
  }

  .clear-btn.show {
    display: block;
  }

  #map {
    flex: 1;
  }

  /* Responsive mobile */
  @media (max-width: 600px) {
    #sidebar {
      grid-template-columns: 1fr;
      min-height: 180px;
    }
    h1 {
      font-size: 18px;
      margin-bottom: 8px;
    }
  }
</style>
</head>
<body>
  <div id="sidebar">
    <h1>Flower Journey Map</h1>

    <label for="placeSelect">Place</label>
    <select id="placeSelect">
      <option value="">-- All Places --</option>
    </select>

    <label for="nameSelect">Name</label>
    <select id="nameSelect">
      <option value="">-- All Names --</option>
    </select>

    <label for="colorSelect">Color</label>
    <select id="colorSelect">
      <option value="">-- All Colors --</option>
    </select>

    <label for="radiusSelect">Radius (meters)</label>
    <select id="radiusSelect">
      <option value="1000">1000</option>
      <option value="3000">3000</option>
      <option value="5000" selected>5000</option>
      <option value="10000">10000</option>
    </select>

    <button id="setAreaPointBtn" title="Click map to set center for area filter">
      Set Area Center
    </button>

    <button id="findInAreaBtn" title="Apply area filter">
      Find in Area
    </button>

    <button id="resetBtn" title="Reset all filters">
      Reset Filters
    </button>
  </div>

  <div id="map"></div>

<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-o9N1j6pQyF7g8HuM8UV32y5Q+hDE8p6RG5f3oW8z7wE="
  crossorigin=""
></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script>
  // Esempio dati finti da sostituire con dati reali
  const flowerData = [
    { place: "Rome", name: "Rose", color: "Red", lat: 41.9028, lng: 12.4964 },
    { place: "Rome", name: "Lily", color: "White", lat: 41.905, lng: 12.49 },
    { place: "Florence", name: "Sunflower", color: "Yellow", lat: 43.7696, lng: 11.2558 },
    { place: "Milan", name: "Tulip", color: "Pink", lat: 45.4642, lng: 9.19 },
    { place: "Naples", name: "Orchid", color: "Purple", lat: 40.8518, lng: 14.2681 },
    // ... altri dati
  ];

  // Mappa e marker cluster
  const map = L.map("map").setView([41.9, 12.5], 6);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 18,
  }).addTo(map);

  const markerClusterGroup = L.markerClusterGroup();
  map.addLayer(markerClusterGroup);

  // Array marker
  const markers = [];

  // Marker e cerchio area
  let areaCenterMarker = null;
  let areaCircle = null;

  // Riferimenti elementi DOM
  const placeSelect = document.getElementById("placeSelect");
  const nameSelect = document.getElementById("nameSelect");
  const colorSelect = document.getElementById("colorSelect");
  const radiusSelect = document.getElementById("radiusSelect");
  const setAreaPointBtn = document.getElementById("setAreaPointBtn");
  const findInAreaBtn = document.getElementById("findInAreaBtn");
  const resetBtn = document.getElementById("resetBtn");

  // Popola dropdown dinamicamente
  function populateDropdowns() {
    const places = [...new Set(flowerData.map((f) => f.place))].sort();
    const names = [...new Set(flowerData.map((f) => f.name))].sort();
    const colors = [...new Set(flowerData.map((f) => f.color))].sort();

    for (const p of places) {
      const option = document.createElement("option");
      option.value = p;
      option.textContent = p;
      placeSelect.appendChild(option);
    }

    for (const n of names) {
      const option = document.createElement("option");
      option.value = n;
      option.textContent = n;
      nameSelect.appendChild(option);
    }

    for (const c of colors) {
      const option = document.createElement("option");
      option.value = c;
      option.textContent = c;
      colorSelect.appendChild(option);
    }
  }

  // Crea markers e aggiungi a cluster (senza filtri)
  function createMarkers() {
    flowerData.forEach((f) => {
      const marker = L.marker([f.lat, f.lng], {
        title: `${f.name} (${f.color}) in ${f.place}`,
      }).bindPopup(
        `<b>${f.name}</b><br/>Color: ${f.color}<br/>Place: ${f.place}`
      );
      marker.data = f;
      markers.push(marker);
      markerClusterGroup.addLayer(marker);
    });
  }

  // Filtro marker basato su selezioni e area
  function filterMarkers() {
    const placeVal = placeSelect.value;
    const nameVal = nameSelect.value;
    const colorVal = colorSelect.value;
    const radius = parseInt(radiusSelect.value, 10);

    markerClusterGroup.clearLayers();

    markers.forEach((marker) => {
      const f = marker.data;

      // Controlla filtri dropdown
      if (
        (placeVal && f.place !== placeVal) ||
        (nameVal && f.name !== nameVal) ||
        (colorVal && f.color !== colorVal)
      ) {
        return;
      }

      // Se area attiva, controlla distanza
      if (areaCenterMarker && areaCircle) {
        const dist = marker.getLatLng().distanceTo(areaCenterMarker.getLatLng());
        if (dist > radius) {
          return;
        }
      }

      // Aggiungi marker se passa filtri
      markerClusterGroup.addLayer(marker);
    });
  }

  // Eventi onchange per filtri
  [placeSelect, nameSelect, colorSelect].forEach((sel) =>
    sel.addEventListener("change", filterMarkers)
  );

  radiusSelect.addEventListener("change", () => {
    // Se cerchio esiste, aggiorna raggio e filtro
    if (areaCircle && areaCenterMarker) {
      const radius = parseInt(radiusSelect.value, 10);
      areaCircle.setRadius(radius);
      filterMarkers();
    }
  });

  // Pulsante set centro area cliccabile sulla mappa
  setAreaPointBtn.addEventListener("click", () => {
    alert("Click on the map to set center for area filter");
    map.once("click", (e) => {
      if (areaCenterMarker) {
        map.removeLayer(areaCenterMarker);
      }
      if (areaCircle) {
        map.removeLayer(areaCircle);
        areaCircle = null;
      }
      areaCenterMarker = L.marker(e.latlng, { title: "Area Center" }).addTo(map);

      const radius = parseInt(radiusSelect.value, 10);

      areaCircle = L.circle(e.latlng, {
        radius,
        color: "blue",
        fillColor: "#3399ff",
        fillOpacity: 0.25,
      }).addTo(map);

      filterMarkers();
      map.setView(e.latlng, 10);
    });
  });

  // Pulsante applica filtro area (utile se vuoi ricalcolare)
  findInAreaBtn.addEventListener("click", () => {
    if (!areaCenterMarker) {
      alert("Set center point first");
      return;
    }
    const radius = parseInt(radiusSelect.value, 10);
    if (areaCircle) areaCircle.setRadius(radius);
    filterMarkers();
  });

  // Reset filtri e area
  resetBtn.addEventListener("click", () => {
    placeSelect.value = "";
    nameSelect.value = "";
    colorSelect.value = "";
    radiusSelect.value = "5000";

    if (areaCenterMarker) {
      map.removeLayer(areaCenterMarker);
      areaCenterMarker = null;
    }
    if (areaCircle) {
      map.removeLayer(areaCircle);
      areaCircle = null;
    }

    filterMarkers();
  });

  // Inizializzazione
  populateDropdowns();
  createMarkers();
  filterMarkers();
</script>
</body>
</html>
