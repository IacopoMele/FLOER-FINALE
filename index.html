<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Flower Journey</title>
  <style>
    * {
      box-sizing: border-box;
    }
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: Arial, sans-serif;
    }
    #app {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    header {
      background: #333;
      color: white;
      padding: 1rem;
      text-align: center;
    }
    main {
      display: flex;
      flex: 1;
      flex-direction: row;
    }
    #controls {
      width: 300px;
      background: #f5f5f5;
      padding: 1rem;
      overflow-y: auto;
    }
    #map {
      flex: 1;
    }
    input, button, select {
      width: 100%;
      padding: 0.5rem;
      margin-bottom: 0.5rem;
      font-size: 1rem;
    }
    @media (max-width: 768px) {
      main {
        flex-direction: column;
      }
      #controls {
        width: 100%;
        order: 2;
      }
      #map {
        height: 50vh;
        order: 1;
      }
    }
  </style>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>
  <div id="app">
    <header>
      <h1>Flower Journey</h1>
    </header>
    <main>
      <div id="controls">
        <input type="text" id="nomeFiore" placeholder="Nome fiore" />
        <button onclick="aggiungiFiore()">Aggiungi fiore</button>
        <button onclick="impostaPuntoRiferimento()">Imposta punto di riferimento</button>
        <hr />
        <input type="text" id="nomeCercato" placeholder="Cerca fiore" />
        <button onclick="cercaFiore()">Cerca</button>
        <hr />
        <select id="diametroArea" onchange="aggiornaArea()">
          <option value="500">500 m</option>
          <option value="1000" selected>1000 m</option>
          <option value="2000">2000 m</option>
        </select>
        <button onclick="filtraPerArea()">Filtra per distanza</button>
      </div>
      <div id="map"></div>
    </main>
  </div>

  <script>
    // Firebase
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Mappa
    let mappa = L.map('map').setView([45.4642, 9.19], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(mappa);

    let puntoRiferimento = null;
    let cerchio = null;

    function aggiungiFiore() {
      mappa.once('click', async function(e) {
        const nome = document.getElementById('nomeFiore').value.trim();
        if (!nome) {
          alert("Inserisci un nome valido.");
          return;
        }
        const { lat, lng } = e.latlng;
        await db.collection("fiori").add({ nome, lat, lng });
        L.marker([lat, lng]).addTo(mappa).bindPopup(nome);
        alert("Fiore aggiunto.");
      });
    }

    function impostaPuntoRiferimento() {
      mappa.once('click', function(e) {
        if (puntoRiferimento) mappa.removeLayer(puntoRiferimento);
        if (cerchio) mappa.removeLayer(cerchio);
        const { lat, lng } = e.latlng;
        puntoRiferimento = L.marker([lat, lng], { draggable: true }).addTo(mappa).bindPopup("Punto di riferimento").openPopup();
        aggiornaArea();
      });
    }

    function aggiornaArea() {
      if (!puntoRiferimento) return;
      const raggio = parseInt(document.getElementById('diametroArea').value) / 2;
      if (cerchio) mappa.removeLayer(cerchio);
      cerchio = L.circle(puntoRiferimento.getLatLng(), { radius: raggio }).addTo(mappa);
    }

    async function cercaFiore() {
      const nome = document.getElementById('nomeCercato').value.trim().toLowerCase();
      const snapshot = await db.collection("fiori").get();
      snapshot.forEach(doc => {
        const fiore = doc.data();
        if (fiore.nome.toLowerCase() === nome) {
          const marker = L.marker([fiore.lat, fiore.lng]).addTo(mappa).bindPopup(fiore.nome).openPopup();
          mappa.setView([fiore.lat, fiore.lng], 16);
        }
      });
    }

    async function filtraPerArea() {
      if (!puntoRiferimento || !cerchio) {
        alert("Imposta prima un punto di riferimento.");
        return;
      }
      const raggio = cerchio.getRadius();
      const centro = cerchio.getLatLng();

      const snapshot = await db.collection("fiori").get();
      snapshot.forEach(doc => {
        const fiore = doc.data();
        const distanza = mappa.distance([fiore.lat, fiore.lng], centro);
        if (distanza <= raggio) {
          L.marker([fiore.lat, fiore.lng]).addTo(mappa).bindPopup(`${fiore.nome} (${Math.round(distanza)} m)`).openPopup();
        }
      });
    }

    // Carica tutti i fiori allâ€™avvio
    window.onload = async () => {
      const snapshot = await db.collection("fiori").get();
      snapshot.forEach(doc => {
        const fiore = doc.data();
        L.marker([fiore.lat, fiore.lng]).addTo(mappa).bindPopup(fiore.nome);
      });
    };
  </script>
</body>
</html>
