<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Flower Journey</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: Arial, sans-serif;
      overflow: hidden;
    }

    #topbar {
      display: flex;
      flex-wrap: wrap;
      background-color: #2e8b57;
      color: white;
      padding: 10px;
      align-items: center;
      gap: 10px;
      justify-content: center;
    }

    #topbar input, #topbar select, #topbar button {
      padding: 5px;
      font-size: 14px;
      border-radius: 4px;
      border: none;
    }

    #topbar input, #topbar select {
      width: 160px;
    }

    #map {
      height: calc(100% - 72px);
    }
  </style>
</head>
<body>
  <div id="topbar">
    <strong>🌸 Flower Journey</strong>
    <button id="addFlowerBtn">➕ Add Flower</button>
    <input type="text" id="flowerName" placeholder="Scientific name" list="gbifSuggestions" disabled>
    <datalist id="gbifSuggestions"></datalist>
    <button id="confirmAddBtn">Confirm</button>

    <input type="text" id="searchFlower" placeholder="Search flower..." list="flowerList">
    <datalist id="flowerList"></datalist>

    <button id="setRefBtn">📍 Set Ref</button>
    <button id="removeRefBtn">❌ Ref</button>
    <button id="findNearestBtn">Find Nearest</button>

    <button id="setAreaBtn">📍 Area Center</button>
    <button id="removeAreaBtn">❌ Area</button>
    <select id="radiusSelect">
      <option value="1000">1 km</option>
      <option value="5000">5 km</option>
      <option value="10000">10 km</option>
      <option value="100000">100 km</option>
      <option value="1000000">1000 km</option>
    </select>
    <button id="findInAreaBtn">Find in Area</button>
  </div>

  <div id="map"></div>

  <!-- Firebase + Leaflet -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyD4K2kMEU6sS_CWBcIC26VrnmDw5DgYOzA",
      authDomain: "flower-journey.firebaseapp.com",
      projectId: "flower-journey",
      storageBucket: "flower-journey.appspot.com",
      messagingSenderId: "982716295253",
      appId: "1:982716295253:web:86e74cbd7fc940c8bcaba1"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Map
    const map = L.map('map', {
      center: [0, 0],
      zoom: 2,
      minZoom: 2
    });
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    const flowerIcon = L.icon({ iconUrl: 'https://unpkg.com/leaflet@1.9.3/dist/images/marker-icon.png' });
    const refIcon = L.icon({ iconUrl: 'https://unpkg.com/leaflet@1.9.3/dist/images/marker-icon-red.png' });

    let flowerMarkers = [];
    let addMode = false;
    let tempLatLng = null;
    let referenceMarker = null;
    let areaCircle = null;
    let areaCenter = null;

    // Add flower
    document.getElementById("addFlowerBtn").onclick = () => {
      addMode = true;
      document.getElementById("flowerName").disabled = false;
    };

    map.on("click", async (e) => {
      if (addMode) {
        tempLatLng = e.latlng;
      }
    });

    document.getElementById("flowerName").addEventListener("input", async (e) => {
      const val = e.target.value;
      const res = await fetch(`https://api.gbif.org/v1/species/suggest?q=${val}`);
      const data = await res.json();
      const datalist = document.getElementById("gbifSuggestions");
      datalist.innerHTML = "";
      data.forEach(d => {
        const option = document.createElement("option");
        option.value = d.scientificName;
        datalist.appendChild(option);
      });
    });

    document.getElementById("confirmAddBtn").onclick = async () => {
      const name = document.getElementById("flowerName").value;
      if (!tempLatLng || !name) return;
      const res = await fetch(`https://api.gbif.org/v1/species/match?name=${name}`);
      const match = await res.json();
      if (match.matchType !== "EXACT") return alert("Invalid name.");
      await db.collection("flowers").add({ name, lat: tempLatLng.lat, lng: tempLatLng.lng });
      document.getElementById("flowerName").value = "";
      document.getElementById("flowerName").disabled = true;
      addMode = false;
    };

    // Load flowers
    function loadFlowers() {
      db.collection("flowers").onSnapshot(snapshot => {
        flowerMarkers.forEach(m => map.removeLayer(m));
        flowerMarkers = [];
        document.getElementById("flowerList").innerHTML = "";
        snapshot.forEach(doc => {
          const { name, lat, lng } = doc.data();
          const marker = L.marker([lat, lng], { icon: flowerIcon }).bindPopup(`<b>${name}</b>`).addTo(map);
          flowerMarkers.push(marker);
          const opt = document.createElement("option");
          opt.value = name;
          document.getElementById("flowerList").appendChild(opt);
        });
      });
    }
    loadFlowers();

    // Reference point
    document.getElementById("setRefBtn").onclick = () => {
      map.once("click", e => {
        if (referenceMarker) map.removeLayer(referenceMarker);
        referenceMarker = L.marker(e.latlng, { icon: refIcon }).bindPopup("Reference Point").addTo(map);
      });
    };
    document.getElementById("removeRefBtn").onclick = () => {
      if (referenceMarker) map.removeLayer(referenceMarker);
      referenceMarker = null;
    };
    document.getElementById("findNearestBtn").onclick = () => {
      if (!referenceMarker) return;
      let minDist = Infinity, nearest = null;
      flowerMarkers.forEach(m => {
        const d = map.distance(referenceMarker.getLatLng(), m.getLatLng());
        if (d < minDist) { minDist = d; nearest = m; }
      });
      if (nearest) nearest.openPopup();
    };

    // Area
    document.getElementById("setAreaBtn").onclick = () => {
      map.once("click", e => {
        areaCenter = e.latlng;
        const r = parseInt(document.getElementById("radiusSelect").value);
        if (areaCircle) map.removeLayer(areaCircle);
        areaCircle = L.circle(areaCenter, { radius: r, color: "orange" }).addTo(map);
      });
    };
    document.getElementById("removeAreaBtn").onclick = () => {
      if (areaCircle) map.removeLayer(areaCircle);
      areaCircle = null;
    };
    document.getElementById("findInAreaBtn").onclick = () => {
      if (!areaCircle) return;
      const r = parseInt(document.getElementById("radiusSelect").value);
      flowerMarkers.forEach(m => {
        const d = map.distance(areaCenter, m.getLatLng());
        if (d <= r) m.openPopup();
      });
    };
  </script>
</body>
</html>

