<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Flower Journey Map</title>
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"
/>
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"
/>
<style>
  body {
    margin: 0;
    font-family: Arial, sans-serif;
    height: 100vh;
    display: flex;
    flex-direction: column;
  }

  #sidebar {
    background-color: #2e8b57;
    padding: 10px 15px;
    box-sizing: border-box;
    user-select: none;
    display: flex;
    flex-wrap: wrap;
    gap: 12px 18px;
    align-items: center;
    justify-content: center;
  }

  #sidebar label {
    color: white;
    font-weight: 600;
    margin-right: 6px;
    white-space: nowrap;
    user-select: none;
  }

  #sidebar select, #sidebar button {
    border-radius: 6px;
    border: none;
    padding: 6px 10px;
    font-size: 14px;
    cursor: pointer;
    min-width: 130px;
    max-width: 180px;
  }

  #sidebar button {
    background-color: #4caf50;
    color: white;
    transition: background-color 0.2s;
  }
  #sidebar button:hover {
    background-color: #45a049;
  }

  #sidebar > div {
    display: flex;
    align-items: center;
    gap: 4px;
  }

  h1 {
    color: white;
    width: 100%;
    text-align: center;
    margin: 0 0 8px 0;
    font-weight: 700;
  }

  #map {
    flex: 1;
  }

  /* Responsive - su mobile facciamo stack verticale */
  @media (max-width: 600px) {
    #sidebar {
      flex-direction: column;
      gap: 10px 0;
    }
    #sidebar > div {
      justify-content: center;
      width: 100%;
    }
    #sidebar select, #sidebar button {
      max-width: 100%;
      min-width: auto;
    }
  }
</style>
</head>
<body>
  <div id="sidebar">
    <h1>Flower Journey Map</h1>

    <div>
      <label for="placeSelect">Place:</label>
      <select id="placeSelect">
        <option value="">-- All Places --</option>
      </select>
    </div>

    <div>
      <label for="nameSelect">Name:</label>
      <select id="nameSelect">
        <option value="">-- All Names --</option>
      </select>
    </div>

    <div>
      <label for="colorSelect">Color:</label>
      <select id="colorSelect">
        <option value="">-- All Colors --</option>
      </select>
    </div>

    <div>
      <label for="radiusSelect">Radius (m):</label>
      <select id="radiusSelect">
        <option value="1000">1000</option>
        <option value="3000">3000</option>
        <option value="5000" selected>5000</option>
        <option value="10000">10000</option>
      </select>
    </div>

    <div>
      <button id="setAreaPointBtn" title="Click map to set center for area filter">Set Area Center</button>
    </div>

    <div>
      <button id="findInAreaBtn" title="Apply area filter">Find in Area</button>
    </div>

    <div>
      <button id="resetBtn" title="Reset all filters">Reset Filters</button>
    </div>
  </div>

  <div id="map"></div>

<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  crossorigin=""
></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script>
  // Esempio dati
  const flowerData = [
    { place: "Rome", name: "Rose", color: "Red", lat: 41.9028, lng: 12.4964 },
    { place: "Rome", name: "Lily", color: "White", lat: 41.905, lng: 12.49 },
    { place: "Florence", name: "Sunflower", color: "Yellow", lat: 43.7696, lng: 11.2558 },
    { place: "Milan", name: "Tulip", color: "Pink", lat: 45.4642, lng: 9.19 },
    { place: "Naples", name: "Orchid", color: "Purple", lat: 40.8518, lng: 14.2681 },
  ];

  const map = L.map("map").setView([41.9, 12.5], 6);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 18,
  }).addTo(map);

  const markerClusterGroup = L.markerClusterGroup();
  map.addLayer(markerClusterGroup);

  const markers = [];

  // Area center e cerchio
  let areaCenterMarker = null;
  let areaCircle = null;

  const placeSelect = document.getElementById("placeSelect");
  const nameSelect = document.getElementById("nameSelect");
  const colorSelect = document.getElementById("colorSelect");
  const radiusSelect = document.getElementById("radiusSelect");
  const setAreaPointBtn = document.getElementById("setAreaPointBtn");
  const findInAreaBtn = document.getElementById("findInAreaBtn");
  const resetBtn = document.getElementById("resetBtn");

  // Riempie i dropdown
  function populateDropdowns() {
    const places = [...new Set(flowerData.map(f => f.place))].sort();
    const names = [...new Set(flowerData.map(f => f.name))].sort();
    const colors = [...new Set(flowerData.map(f => f.color))].sort();

    places.forEach(p => {
      const option = document.createElement("option");
      option.value = p;
      option.textContent = p;
      placeSelect.appendChild(option);
    });

    names.forEach(n => {
      const option = document.createElement("option");
      option.value = n;
      option.textContent = n;
      nameSelect.appendChild(option);
    });

    colors.forEach(c => {
      const option = document.createElement("option");
      option.value = c;
      option.textContent = c;
      colorSelect.appendChild(option);
    });
  }

  // Crea tutti i marker sulla mappa
  function createMarkers() {
    flowerData.forEach(f => {
      const marker = L.marker([f.lat, f.lng], {title: `${f.name} (${f.color}) in ${f.place}`})
        .bindPopup(`<b>${f.name}</b><br/>Color: ${f.color}<br/>Place: ${f.place}`);
      marker.data = f;
      markers.push(marker);
      markerClusterGroup.addLayer(marker);
    });
  }

  // Funzione filtro che funziona esattamente come prima:
  // filtro singolo e combinato per place, name, color
  // filtro area opzionale se cerchio settato
  function filterMarkers() {
    const placeVal = placeSelect.value;
    const nameVal = nameSelect.value;
    const colorVal = colorSelect.value;
    const radius = parseInt(radiusSelect.value, 10);

    markerClusterGroup.clearLayers();

    markers.forEach(marker => {
      const f = marker.data;

      // Filtri dropdown
      if (
        (placeVal && f.place !== placeVal) ||
        (nameVal && f.name !== nameVal) ||
        (colorVal && f.color !== colorVal)
      ) {
        return;
      }

      // Se c'Ã¨ area, filtro per distanza
      if (areaCenterMarker && areaCircle) {
        const dist = marker.getLatLng().distanceTo(areaCenterMarker.getLatLng());
        if (dist > radius) return;
      }

      markerClusterGroup.addLayer(marker);
    });
  }

  // Al cambio di dropdown filtro immediatamente
  [placeSelect, nameSelect, colorSelect].forEach(sel =>
    sel.addEventListener("change", filterMarkers)
  );

  // Cambio radius aggiorna cerchio e filtra se cerchio presente
  radiusSelect.addEventListener("change", () => {
    if (areaCircle && areaCenterMarker) {
      const radius = parseInt(radiusSelect.value, 10);
      areaCircle.setRadius(radius);
      filterMarkers();
    }
  });

  // Pulsante "Set Area Center" permette di cliccare sulla mappa per settare il centro area
  setAreaPointBtn.addEventListener("click", () => {
    alert("Click on the map to set the center point for the area filter");
    map.once("click", e => {
      if (areaCenterMarker) map.removeLayer(areaCenterMarker);
      if (areaCircle) map.removeLayer(areaCircle);

      areaCenterMarker = L.marker(e.latlng, {title: "Area Center"}).addTo(map);

      const radius = parseInt(radiusSelect.value, 10);
      areaCircle = L.circle(e.latlng, {
        radius,
        color: "blue",
        fillColor: "#3399ff",
        fillOpacity: 0.25,
      }).addTo(map);

      filterMarkers();
      map.setView(e.latlng, 10);
    });
  });

  // Pulsante "Find in Area" applica filtro area (deve esserci centro settato)
  findInAreaBtn.addEventListener("click", () => {
    if (!areaCenterMarker) {
      alert("Please set the area center first");
      return;
    }
    const radius = parseInt(radiusSelect.value, 10);
    if (areaCircle) areaCircle.setRadius(radius);
    filterMarkers();
  });

  // Reset di tutti i filtri e area
  resetBtn.addEventListener("click", () => {
    placeSelect.value = "";
    nameSelect.value = "";
    colorSelect.value = "";
    radiusSelect.value = "5000";

    if (areaCenterMarker) {
      map.removeLayer(areaCenterMarker);
      areaCenterMarker = null;
    }
    if (areaCircle) {
      map.removeLayer(areaCircle);
      areaCircle = null;
    }

    filterMarkers();
  });

  // Inizializzo tutto
  populateDropdowns();
  createMarkers();
  filterMarkers();
</script>
</body>
</html>

