
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>FLOWER JOURNEY</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: Arial, sans-serif;
      background-color: forestgreen;
      color: white;
      overflow: hidden;
    }

    body {
      display: flex;
      flex-direction: column;
    }

    #topbar {
      background-color: #2e8b57;
      padding: 10px;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 12px;
      justify-content: center;
    }

    #topbar h1 {
      margin-right: 20px;
      font-size: 22px;
      white-space: nowrap;
    }

    .section {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
      background-color: rgba(255, 255, 255, 0.1);
      padding: 8px 10px;
      border-radius: 6px;
    }

    label {
      font-size: 14px;
    }

    input[type="text"], select {
      font-size: 14px;
      padding: 5px;
      border-radius: 4px;
      border: none;
      color: black;
    }

    button {
      padding: 6px 10px;
      font-size: 14px;
      border-radius: 4px;
      border: none;
      background: white;
      color: black;
      cursor: pointer;
    }

    button:hover {
      background: #ddd;
    }

    #map {
      flex: 1;
    }
  </style>
</head>
<body>
  <div id="topbar">
    <h1>üå∏ Flower Journey</h1>

    <div class="section" id="addSection">
      <button id="addFlowerBtn">‚ûï Add</button>
      <input type="text" id="newFlowerName" placeholder="Flower name" disabled list="gbifSuggestions" />
      <datalist id="gbifSuggestions"></datalist>
      <button id="confirmAddBtn">Confirm</button>
    </div>

    <div class="section" id="searchSection">
      <input type="text" id="searchName" placeholder="Search flower..." list="flowersList" />
      <datalist id="flowersList"></datalist>
      <button id="setReference">üìç Set Ref</button>
      <button id="removeReference">‚ùå Ref</button>
      <button id="findNearest">Nearest</button>
    </div>

    <div class="section" id="areaSection">
      <button id="setAreaPoint">üìç Area Center</button>
      <button id="removeArea">‚ùå Area</button>
      <select id="radius">
        <option value="1000">1 km</option>
        <option value="5000">5 km</option>
        <option value="10000">10 km</option>
        <option value="100000">100 km</option>
        <option value="1000000">1000 km</option>
      </select>
      <button id="findInArea">Find in Area</button>
    </div>
  </div>

  <div id="map"></div>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyD4K2kMEU6sS_CWBcIC26VrnmDw5DgYOzA",
      authDomain: "flower-journey.firebaseapp.com",
      projectId: "flower-journey",
      storageBucket: "flower-journey.appspot.com",
      messagingSenderId: "982716295253",
      appId: "1:982716295253:web:86e74cbd7fc940c8bcaba1"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const flowerIcon = L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/512/290/290990.png', iconSize: [32, 32], iconAnchor: [16, 32] });
    const refIcon = L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/512/535/535239.png', iconSize: [32, 32], iconAnchor: [16, 32] });

    const map = L.map('map', {
      minZoom: 2,
      worldCopyJump: true
    }).setView([0, 0], 2);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);

    const markers = L.markerClusterGroup();
    map.addLayer(markers);

    const flowersList = document.getElementById("flowersList");
    const gbifSuggestions = document.getElementById("gbifSuggestions");

    let currentFlowerName = "";
    let addMode = false;
    let referenceMarker = null;
    let areaCenter = null;
    let areaCircle = null;

    function addFlowerToMap(doc) {
      const marker = L.marker([doc.lat, doc.lng], { icon: flowerIcon }).bindPopup(`<b>${doc.name}</b>`);
      markers.addLayer(marker);
    }

    function updateFlowersList() {
      flowersList.innerHTML = "";
      db.collection("flowers").get().then(snapshot => {
        snapshot.forEach(doc => {
          const option = document.createElement("option");
          option.value = doc.data().name;
          flowersList.appendChild(option);
        });
      });
    }

    db.collection("flowers").onSnapshot(snapshot => {
      markers.clearLayers();
      snapshot.forEach(doc => addFlowerToMap(doc.data()));
      updateFlowersList();
    });

    document.getElementById("addFlowerBtn").onclick = () => {
      addMode = true;
      document.getElementById("newFlowerName").disabled = false;
    };

    document.getElementById("newFlowerName").addEventListener("input", async (e) => {
      const query = e.target.value;
      if (!query) return;
      const res = await fetch(`https://api.gbif.org/v1/species/suggest?q=${query}`);
      const data = await res.json();
      gbifSuggestions.innerHTML = "";
      data.forEach(species => {
        const option = document.createElement("option");
        option.value = species.scientificName;
        gbifSuggestions.appendChild(option);
      });
    });

    let tempLatLng = null;
    map.on("click", e => {
      if (!addMode) return;
      tempLatLng = e.latlng;
    });

    document.getElementById("confirmAddBtn").onclick = async () => {
      if (!tempLatLng) return;
      const name = document.getElementById("newFlowerName").value;
      if (!name) return;
      const res = await fetch(`https://api.gbif.org/v1/species/match?name=${name}`);
      const match = await res.json();
      if (match.matchType !== "EXACT") return alert("Invalid scientific name.");

      await db.collection("flowers").add({ name, lat: tempLatLng.lat, lng: tempLatLng.lng });

      document.getElementById("newFlowerName").value = "";
      document.getElementById("newFlowerName").disabled = true;
      addMode = false;
      tempLatLng = null;
    };

    document.getElementById("setReference").onclick = () => {
      map.once("click", e => {
        if (referenceMarker) map.removeLayer(referenceMarker);
        referenceMarker = L.marker(e.latlng, { icon: refIcon }).addTo(map).bindPopup("Reference Point").openPopup();
      });
    };

    document.getElementById("removeReference").onclick = () => {
      if (referenceMarker) map.removeLayer(referenceMarker);
      referenceMarker = null;
    };

    document.getElementById("findNearest").onclick = () => {
      if (!referenceMarker) return;
      let minDist = Infinity;
      let nearest = null;
      markers.eachLayer(marker => {
        const dist = map.distance(referenceMarker.getLatLng(), marker.getLatLng());
        if (dist < minDist) {
          minDist = dist;
          nearest = marker;
        }
      });
      if (nearest) nearest.openPopup();
    };

    document.getElementById("setAreaPoint").onclick = () => {
      map.once("click", e => {
        if (areaCircle) map.removeLayer(areaCircle);
        areaCenter = e.latlng;
        areaCircle = L.circle(areaCenter, { radius: parseInt(document.getElementById("radius").value), color: "yellow" }).addTo(map);
      });
    };

    document.getElementById("removeArea").onclick = () => {
      if (areaCircle) map.removeLayer(areaCircle);
      areaCircle = null;
      areaCenter = null;
    };

    document.getElementById("findInArea").onclick = () => {
      if (!areaCircle) return;
      const radius = parseInt(document.getElementById("radius").value);
      markers.eachLayer(marker => {
        const dist = map.distance(areaCenter, marker.getLatLng());
        if (dist <= radius) marker.openPopup();
      });
    };
  </script>
</body>
</html>
